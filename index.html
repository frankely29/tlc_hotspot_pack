<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NYC HVFHV Zones for Driver Earnings</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100vw; }
    #ui {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(255,255,255,0.94);
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.25);
      max-width: 260px;
      border: 2px solid #111;
      font-size: 13.5px;
    }
    button { 
      padding: 9px 12px; 
      font-size: 14px; 
      font-weight: bold; 
      border: none; 
      border-radius: 7px; 
      margin: 6px 3px 6px 0; 
      width: 48%; 
    }
    #btnNow, #btnGenerate { background: #1976d2; color: white; }
    #timeLabel { font-weight: 900; font-size: 16.5px; margin: 8px 0 3px; }
    #status { font-size: 12.5px; color: #333; line-height: 1.35; }
    .legendBar { 
      height: 10px; 
      border-radius: 5px; 
      margin: 8px 0; 
      background: linear-gradient(to right, #2e7d32, #1976d2, #81d4fa, #d32f2f); 
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="ui">
    <strong>NYC HVFHV Zones (1â€“100) for Driver Earnings</strong><br><br>
    
    <strong>Colors (Demand-Based Rating):</strong><br>
    ðŸŸ¢ Green = Best (High Demand/Earnings)<br>
    ðŸ”µ Blue = Medium<br>
    ðŸŸ¦ Sky = Normal<br>
    ðŸ”´ Red = Avoid (Low Demand)<br><br>
    
    <div class="legendBar"></div>
    <small>High rating â†’ Low rating</small><br><br>

    <button id="btnNow">Now (NYC)</button>
    <button id="btnGenerate">Generate / Refresh</button>

    <div id="timeLabel">Loading NYC timeâ€¦</div>
    <div id="status">Checking Railway volumeâ€¦</div>
    <input type="range" id="slider" min="0" max="0" value="0" step="1"/>
  </div>

  <script>
    const BASE = "https://web-production-78f67.up.railway.app".replace(/\/+$/, "");
    const BIN_MINUTES = 20;

    function ratingToColor(r) {
      r = Math.max(1, Math.min(100, Number(r) || 1));
      if (r <= 25) return "#d32f2f";
      if (r <= 50) return "#81d4fa";
      if (r <= 75) return "#1976d2";
      return "#2e7d32";
    }

    const map = L.map("map").setView([40.72, -73.98], 12);
    L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    const polyLayer = L.geoJSON(null, {
      style: f => ({
        stroke: true,
        color: "#111",
        weight: 2.2,
        fillColor: ratingToColor(f.properties?.rating || 50),
        fillOpacity: 0.82
      })
    }).addTo(map);

    let timeline = [];
    const slider = document.getElementById("slider");
    const timeLabel = document.getElementById("timeLabel");
    const statusEl = document.getElementById("status");

    function setStatus(msg) { statusEl.innerHTML = msg; }

    function nycTimeLabel(iso) {
      return new Date(iso).toLocaleString("en-US", {
        timeZone: "America/New_York",
        weekday: "short", hour: "numeric", minute: "2-digit", hour12: true
      });
    }

    function getNYCMinuteOfWeek(iso) {
      const d = new Date(iso);
      const f = new Intl.DateTimeFormat("en-US", { timeZone: "America/New_York", weekday: "short", hour: "numeric", minute: "numeric" });
      const p = f.formatToParts(d);
      const dowMap = { Mon:0, Tue:1, Wed:2, Thu:3, Fri:4, Sat:5, Sun:6 };
      const dow = dowMap[p.find(x=>x.type==="weekday").value] ?? 0;
      const h = +p.find(x=>x.type==="hour").value;
      const m = +p.find(x=>x.type==="minute").value;
      return dow * 1440 + h * 60 + m;
    }

    function pickClosestIndex() {
      if (!timeline.length) return 0;
      const nowM = getNYCMinuteOfWeek(new Date());
      const week = 7 * 1440;
      let best = 0, bestD = Infinity;
      for (let i = 0; i < timeline.length; i++) {
        const d = Math.min(Math.abs(getNYCMinuteOfWeek(timeline[i]) - nowM), week - Math.abs(getNYCMinuteOfWeek(timeline[i]) - nowM));
        if (d < bestD) { bestD = d; best = i; }
      }
      return best;
    }

    async function apiGET(path) {
      const r = await fetch(`${BASE}${path}`, {cache:"no-store"});
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    async function loadFrame(idx) {
      const data = await apiGET(`/frame/${idx}`);
      polyLayer.clearLayers();
      polyLayer.addData(data.polygons || data);
      timeLabel.textContent = nycTimeLabel(data.time || timeline[idx]);
      setStatus(`Loaded ${timeline.length} steps from Railway âœ…`);
    }

    async function boot() {
      setStatus("Checking Railway volumeâ€¦");
      try {
        const data = await apiGET("/timeline");
        timeline = Array.isArray(data) ? data : (data.timeline || []);
        
        if (timeline.length === 0) throw new Error("empty");

        slider.max = timeline.length - 1;
        const startIdx = pickClosestIndex();
        slider.value = startIdx;
        await loadFrame(startIdx);

        setInterval(() => {
          if (document.visibilityState === "visible") {
            const idx = pickClosestIndex();
            slider.value = idx;
            loadFrame(idx);
          }
        }, 60000);

      } catch (e) {
        setStatus("No processed data yet.<br>Click <strong>Generate / Refresh</strong> once to build from your PARQUET files in Railway volume.");
      }
    }

    slider.addEventListener("input", () => loadFrame(+slider.value));
    
    document.getElementById("btnNow").onclick = () => {
      const idx = pickClosestIndex();
      slider.value = idx;
      loadFrame(idx);
    };

    document.getElementById("btnGenerate").onclick = async () => {
      setStatus("Processing on Railwayâ€¦ (1â€“2 min)<br>After it finishes the map will auto-load.");
      try {
        await fetch(`${BASE}/generate?bin_minutes=20&good_n=200&bad_n=120&win_good_n=80&win_bad_n=40&min_trips_per_window=10&simplify_meters=25`, {method:"POST"});
        setTimeout(boot, 90000);
      } catch (e) {
        setStatus("Generate failed â€“ check Railway logs");
      }
    };

    boot();
  </script>
</body>
</html>